<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Pose Trainer v3.2</title>
    <style>
        /* --- CORE STYLES --- */
        :root {
            --primary: #00d2d3;
            --primary-hover: #00b5b6;
            --bg: #121212;
            --panel-bg: rgba(30, 30, 30, 0.85);
            --text: #ffffff;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: var(--font);
            margin: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            user-select: none;
        }

        /* --- SCREENS --- */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            overflow-y: auto;
            animation: fadeIn 0.4s ease;
        }
        .active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1, h2 { font-weight: 300; letter-spacing: 1px; margin-top: 0; }

        /* --- UI ELEMENTS --- */
        button.btn-main {
            background: var(--primary);
            color: #000;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 700;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
            text-transform: uppercase;
        }
        button.btn-main:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(0, 210, 211, 0.4); background: var(--primary-hover); }

        button.btn-sec {
            background: transparent;
            color: #888;
            border: 1px solid #444;
            padding: 8px 25px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }
        button.btn-sec:hover { color: #fff; border-color: #fff; background: rgba(255,255,255,0.05); }

        input[type="number"] {
            background: #222; border: 1px solid #444; color: #fff;
            padding: 10px; border-radius: 8px; width: 80px; text-align: center; font-size: 16px;
        }

        /* --- UPLOAD AREA --- */
        .upload-box {
            border: 2px dashed #444;
            padding: 60px;
            border-radius: 20px;
            text-align: center;
            background: rgba(255,255,255,0.02);
            transition: border-color 0.3s;
        }
        .upload-box:hover { border-color: var(--primary); }

        /* --- CATEGORY GRID --- */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            width: 80%;
            max-width: 1000px;
            padding-bottom: 50px;
            margin-top: 20px;
        }
        .cat-card {
            background: #1e1e1e;
            padding: 25px;
            border-radius: 15px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            border: 1px solid transparent;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .cat-card:hover { background: #2a2a2a; border-color: var(--primary); transform: translateY(-5px); }
        
        /* –û—Å–æ–±—ã–π —Å—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ Mix All */
        .cat-card.mix-all {
            background: linear-gradient(135deg, #1e1e1e 0%, #252525 100%);
            border: 1px solid #444;
        }
        .cat-card.mix-all:hover { border-color: #fff; }

        /* --- SETTINGS --- */
        .settings-wrap {
            background: #1e1e1e;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .setting-row { margin-bottom: 25px; }
        .setting-label { display: block; margin-bottom: 12px; color: #aaa; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        
        .radio-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .radio-group label {
            cursor: pointer; background: #2c2c2c; padding: 10px 18px; border-radius: 10px; font-size: 14px;
            transition: 0.2s; border: 1px solid transparent;
        }
        .radio-group input { display: none; }
        .radio-group input:checked + span { color: var(--primary); font-weight: bold; }
        .radio-group label:has(input:checked) { background: rgba(0, 210, 211, 0.1); border-color: var(--primary); }

        .time-prediction { color: var(--primary); font-size: 20px; margin: 20px 0; font-weight: bold; text-align: center; }

        /* --- PLAYER & HUD --- */
        #player-container {
            width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            background: #000; position: relative; cursor: pointer;
        }

        #current-image {
            display: block; height: 100vh; width: auto; max-width: 100vw; object-fit: contain;
        }

        .hud-top-display {
            position: fixed; top: 20px;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
            padding: 8px 16px; border-radius: 8px;
            font-family: monospace; font-size: 20px; font-weight: 700; color: #fff;
            pointer-events: none; z-index: 100; transition: opacity 0.5s;
        }
        #hud-timer { right: 20px; color: var(--primary); }
        #hud-counter { left: 20px; color: #ccc; }

        .hud-controls {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.9); backdrop-filter: blur(12px);
            padding: 12px 30px; border-radius: 50px;
            display: flex; align-items: center; gap: 25px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            transition: opacity 0.3s, transform 0.3s; z-index: 100;
        }
        .hud-controls.hidden { opacity: 0; transform: translate(-50%, 40px); pointer-events: none; }

        .hud-btn {
            background: transparent; border: none; color: #fff;
            font-size: 0; cursor: pointer;
            width: 44px; height: 44px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        .hud-btn:hover { background: rgba(255,255,255,0.2); }
        .hud-btn svg { width: 24px; height: 24px; fill: currentColor; }

        .sep { width: 1px; height: 24px; background: #555; }

    </style>
</head>
<body>

    <!-- 1. START SCREEN -->
    <div id="screen-upload" class="screen active">
        <h1>REFERENCE TRAINER</h1>
        <div class="upload-box">
            <input type="file" id="folderInput" webkitdirectory directory multiple style="display:none">
            <button class="btn-main" onclick="document.getElementById('folderInput').click()">üìÇ –í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É</button>
            <p style="color: #666; font-size: 13px; margin-top: 15px;">
                <span id="db-status">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</span>
            </p>
        </div>
    </div>

    <!-- 2. CATEGORY SCREEN -->
    <div id="screen-categories" class="screen">
        <h2>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h2>
        <div id="categories-container" class="grid"></div>
        <button class="btn-sec" onclick="location.reload()">‚¨Ö –°–º–µ–Ω–∏—Ç—å –ø–∞–ø–∫—É</button>
    </div>

    <!-- 3. SETTINGS SCREEN -->
    <div id="screen-settings" class="screen">
        <h2 id="settings-title" style="margin-bottom: 20px; color:#fff;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Å—Å–∏–∏</h2>
        
        <div class="settings-wrap">
            <!-- –¢–∞–π–º–µ—Ä -->
            <div class="setting-row">
                <span class="setting-label">–¢–∞–π–º–µ—Ä (–Ω–∞ –æ–¥–Ω–æ —Ñ–æ—Ç–æ)</span>
                <div class="radio-group">
                    <label><input type="radio" name="timer" value="30" onchange="calcTime()"><span>30 —Å–µ–∫</span></label>
                    <label><input type="radio" name="timer" value="60" onchange="calcTime()"><span>1 –º–∏–Ω</span></label>
                    <label><input type="radio" name="timer" value="120" checked onchange="calcTime()"><span>2 –º–∏–Ω</span></label>
                    <label><input type="radio" name="timer" value="300" onchange="calcTime()"><span>5 –º–∏–Ω</span></label>
                    <label><input type="radio" name="timer" value="0" onchange="calcTime()"><span>‚àû</span></label>
                </div>
            </div>

            <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ -->
            <div class="setting-row">
                <span class="setting-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</span>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <input type="number" id="customCount" value="20" min="1" oninput="calcTime()">
                    <span style="font-size: 13px; color: #777;">(–ú–∞–∫—Å: <span id="max-count-label">0</span>)</span>
                </div>
                <div style="margin-top: 8px;">
                    <a href="#" onclick="setCount(-1); return false;" style="color:#00d2d3; font-size:13px; text-decoration:none; border-bottom:1px dashed;">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ</a>
                </div>
            </div>

            <!-- –ò—Ç–æ–≥ -->
            <div id="time-prediction" class="time-prediction">~ 40 –º–∏–Ω</div>

            <div style="margin-top: 30px; display: flex; justify-content: space-between;">
                <button class="btn-sec" onclick="goBackFromSettings()">–ù–∞–∑–∞–¥</button>
                <button class="btn-main" onclick="startSession()">–ù–ê–ß–ê–¢–¨ ‚ñ∂</button>
            </div>
        </div>
    </div>

    <!-- 4. PLAYER SCREEN -->
    <div id="screen-player" class="screen" style="overflow: hidden;">
        
        <div id="hud-counter" class="hud-top-display">0 / 0</div>
        <div id="hud-timer" class="hud-top-display">00:00</div>

        <div id="player-container" onclick="showUI()">
            <img id="current-image" src="" alt="">
        </div>

        <div id="hud-controls" class="hud-controls">
            <button class="hud-btn" onclick="prevImage()" title="–ù–∞–∑–∞–¥">
                <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            </button>
            <div class="sep"></div>
            <button class="hud-btn" id="btn-pause" onclick="togglePause()" title="–ü–∞—É–∑–∞">
                <svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>
            <button class="hud-btn" onclick="forceNext()" title="–í–ø–µ—Ä–µ–¥">
                <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
            </button>
            <div class="sep"></div>
            <button class="hud-btn" onclick="hideUI(event)" title="–°–∫—Ä—ã—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å" style="opacity: 0.7;">
                <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </button>
        </div>
    </div>

    <script>
        /* --- STATE --- */
        let dbFiles = {}; 
        let sessionQueue = [];
        let currentIdx = 0;
        let timerDuration = 120;
        let timeLeft = 0;
        let timerInterval = null;
        let isPaused = false;
        
        let currentCategory = ""; 
        let isFlatMode = false; // –§–ª–∞–≥: –µ—Å–ª–∏ true, –∑–Ω–∞—á–∏—Ç –º—ã –≤—ã–±—Ä–∞–ª–∏ –ø–∞–ø–∫—É —Ç–æ–ª—å–∫–æ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏
        const ROOT_KEY = "__ROOT__";
        const ALL_KEY = "__ALL_COMBINED__";
        
        // --- DATABASE ---
        const STORAGE_KEY = 'pose_trainer_db_v3';
        let viewHistory = {};

        function initDB() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    viewHistory = JSON.parse(saved);
                    const count = Object.keys(viewHistory).length;
                    document.getElementById('db-status').innerText = `–ò—Å—Ç–æ—Ä–∏—è: ${count} —Ñ–∞–π–ª–æ–≤`;
                    document.getElementById('db-status').style.color = "#00d2d3";
                }
            } catch (e) { console.error(e); }
        }
        initDB();

        function saveHistory(fileKey) {
            if (!viewHistory[fileKey]) viewHistory[fileKey] = 0;
            viewHistory[fileKey]++;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(viewHistory));
        }

        // --- FILE PARSING (NEW LOGIC) ---
        document.getElementById('folderInput').addEventListener('change', (e) => {
            const files = e.target.files;
            dbFiles = {};
            isFlatMode = false;

            if (files.length === 0) return;

            // 1. –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
            for (let f of files) {
                if (f.name.startsWith('.') || !f.type.startsWith('image/')) continue;
                
                const parts = f.webkitRelativePath.split('/');
                
                // parts[0] - –∏–º—è –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏, –∫–æ—Ç–æ—Ä—É—é –≤—ã–±—Ä–∞–ª–∏
                // parts[1] - —Ñ–∞–π–ª (–µ—Å–ª–∏ –≤ –∫–æ—Ä–Ω–µ) –ò–õ–ò –ø–∞–ø–∫–∞ (–µ—Å–ª–∏ –≤–ª–æ–∂–µ–Ω)
                
                if (parts.length === 2) {
                    // –≠—Ç–æ —Ñ–∞–π–ª –ø—Ä—è–º–æ –≤ –∫–æ—Ä–Ω–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞–ø–∫–∏
                    if (!dbFiles[ROOT_KEY]) dbFiles[ROOT_KEY] = [];
                    dbFiles[ROOT_KEY].push(f);
                } else if (parts.length > 2) {
                    // –≠—Ç–æ —Ñ–∞–π–ª –≤ –ø–æ–¥–ø–∞–ø–∫–µ
                    const cat = parts[1];
                    if (!dbFiles[cat]) dbFiles[cat] = [];
                    dbFiles[cat].push(f);
                }
            }

            // 2. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
            const subCategories = Object.keys(dbFiles).filter(k => k !== ROOT_KEY);

            if (subCategories.length === 0 && dbFiles[ROOT_KEY]) {
                // –°–õ–£–ß–ê–ô 1: –ü–∞–ø–∫–∞ "–ø–ª–æ—Å–∫–∞—è" (—Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–∏–Ω–∫–∏)
                isFlatMode = true;
                openSettings(ROOT_KEY);
            } else {
                // –°–õ–£–ß–ê–ô 2: –ï—Å—Ç—å –ø–æ–¥–ø–∞–ø–∫–∏.
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º ROOT_KEY (–æ–¥–∏–Ω–æ—á–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –∫–æ—Ä–Ω–µ), –∫–∞–∫ –ø—Ä–æ—Å–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.
                renderCategories(subCategories);
                switchScreen('screen-categories');
            }
        });

        function renderCategories(cats) {
            const container = document.getElementById('categories-container');
            container.innerHTML = '';

            // –ö–Ω–æ–ø–∫–∞ "MIX ALL"
            const mixBtn = document.createElement('div');
            mixBtn.className = 'cat-card mix-all';
            let totalCount = 0;
            cats.forEach(c => totalCount += dbFiles[c].length);
            
            mixBtn.innerHTML = `<div style="font-size:24px; margin-bottom:5px;">üîÄ</div>
                                <div style="font-size:18px; font-weight:bold;">–ú–∏–∫—Å (–í—Å–µ)</div>
                                <div style="font-size:14px; color:#aaa;">${cats.length} –ø–∞–ø–æ–∫ (${totalCount} —Ñ–æ—Ç–æ)</div>`;
            mixBtn.onclick = () => prepareMixSession();
            container.appendChild(mixBtn);

            // –û–±—ã—á–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            cats.forEach(cat => {
                const div = document.createElement('div');
                div.className = 'cat-card';
                div.innerHTML = `<div style="font-size:18px; font-weight:bold; margin-bottom:5px;">${cat}</div>
                                 <div style="font-size:14px; color:#777;">${dbFiles[cat].length} —Ñ–æ—Ç–æ</div>`;
                div.onclick = () => openSettings(cat);
                container.appendChild(div);
            });
        }

        // --- NAVIGATION ---
        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function goBackFromSettings() {
            if (isFlatMode) {
                // –ï—Å–ª–∏ –º—ã –≤ —Ä–µ–∂–∏–º–µ "–æ–¥–Ω–æ–π –ø–∞–ø–∫–∏", –Ω–∞–∑–∞–¥ = –∫ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–π
                location.reload(); 
            } else {
                // –ò–Ω–∞—á–µ –Ω–∞–∑–∞–¥ = –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                switchScreen('screen-categories');
            }
        }

        // --- SETTINGS LOGIC ---
        function openSettings(catKey) {
            currentCategory = catKey;
            
            let count = 0;
            let title = "";

            if (catKey === ROOT_KEY) {
                title = "–í–∞—à–∞ –ø–∞–ø–∫–∞";
                count = dbFiles[ROOT_KEY].length;
            } else if (catKey === ALL_KEY) {
                title = "–ú–∏–∫—Å –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π";
                // –°—á–∏—Ç–∞–µ–º –Ω–∞ –ª–µ—Ç—É
                Object.keys(dbFiles).forEach(k => {
                    if (k !== ROOT_KEY && k !== ALL_KEY) count += dbFiles[k].length;
                });
            } else {
                title = catKey;
                count = dbFiles[catKey].length;
            }

            document.getElementById('settings-title').innerText = title;
            document.getElementById('max-count-label').innerText = count;
            
            // –°–±—Ä–æ—Å input, –µ—Å–ª–∏ —Ç–∞–º —á–∏—Å–ª–æ –±–æ–ª—å—à–µ, —á–µ–º –µ—Å—Ç—å
            const input = document.getElementById('customCount');
            if (parseInt(input.value) > count || parseInt(input.value) < 1) input.value = 20;
            
            calcTime();
            switchScreen('screen-settings');
        }

        function prepareMixSession() {
            // –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
            // –ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ –º—ã –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞–≤–∏–º —Ñ–ª–∞–≥-–∫–ª—é—á ALL_KEY
            openSettings(ALL_KEY);
        }

        function setCount(val) {
            const input = document.getElementById('customCount');
            const max = parseInt(document.getElementById('max-count-label').innerText);
            
            if (val === -1) input.value = max;
            else input.value = val;
            calcTime();
        }

        function calcTime() {
            const timeRad = document.querySelector('input[name="timer"]:checked');
            const timeVal = parseInt(timeRad.value);
            const countInput = document.getElementById('customCount');
            let countVal = parseInt(countInput.value);
            const max = parseInt(document.getElementById('max-count-label').innerText);

            if (isNaN(countVal) || countVal < 1) countVal = 1;
            
            const label = document.getElementById('time-prediction');
            
            // –†–∞—Å—á–µ—Ç
            const actualCount = Math.min(countVal, max);
            
            if (timeVal === 0) {
                label.innerText = `–í—Ä–µ–º—è: ‚àû (${actualCount} —Ñ–æ—Ç–æ)`;
            } else {
                const totalMin = Math.ceil((timeVal * actualCount) / 60);
                label.innerText = `~ ${totalMin} –º–∏–Ω (${actualCount} —Ñ–æ—Ç–æ)`;
            }
        }

        // --- START & ALGORITHM ---
        function startSession() {
            let sourceFiles = [];

            if (currentCategory === ALL_KEY) {
                // –°–æ–±–∏—Ä–∞–µ–º –≤—Å—ë –∫—Ä–æ–º–µ ROOT
                Object.keys(dbFiles).forEach(k => {
                    if (k !== ROOT_KEY) sourceFiles.push(...dbFiles[k]);
                });
            } else {
                sourceFiles = dbFiles[currentCategory];
            }

            let countRequested = parseInt(document.getElementById('customCount').value);
            if (isNaN(countRequested) || countRequested < 1) countRequested = 20;
            if (countRequested > sourceFiles.length) countRequested = sourceFiles.length;

            timerDuration = parseInt(document.querySelector('input[name="timer"]:checked').value);

            // WEIGHTED SHUFFLE
            let scored = sourceFiles.map(f => {
                const key = f.webkitRelativePath;
                const seen = viewHistory[key] || 0;
                // –§–æ—Ä–º—É–ª–∞ –≤–µ—Å–∞: —Ä–µ–∂–µ –≤–∏–¥–µ–ª–∏ = –≤—ã—à–µ –≤–µ—Å
                const weight = (1 / (seen + 0.5)) * Math.random();
                return { file: f, weight: weight, key: key };
            });

            scored.sort((a, b) => b.weight - a.weight); // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤–µ—Å—É (–ª—É—á—à–∏–µ —Å–≤–µ—Ä—Ö—É)
            let selected = scored.slice(0, countRequested); // –û–±—Ä–µ–∑–∞–µ–º
            selected.sort(() => Math.random() - 0.5); // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ

            sessionQueue = selected;
            currentIdx = 0;

            if (sessionQueue.length === 0) return alert("–û—à–∏–±–∫–∞: –Ω–µ—Ç —Ñ–∞–π–ª–æ–≤");

            switchScreen('screen-player');
            loadSlide();
        }

        // --- PLAYER LOGIC ---
        function loadSlide() {
            if (currentIdx >= sessionQueue.length) {
                endSession();
                return;
            }

            const item = sessionQueue[currentIdx];
            const img = document.getElementById('current-image');
            img.src = URL.createObjectURL(item.file);

            // UI Updates
            document.getElementById('hud-counter').innerText = `${currentIdx + 1} / ${sessionQueue.length}`;
            saveHistory(item.key);

            // Timer Reset
            clearInterval(timerInterval);
            if (timerDuration > 0) {
                timeLeft = timerDuration;
                updateTimerDisplay();
                isPaused = false;
                updatePauseIcon();
                startTimer();
            } else {
                document.getElementById('hud-timer').innerText = "‚àû";
                document.getElementById('hud-timer').style.color = "#00d2d3";
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                if (!isPaused) {
                    timeLeft--;
                    updateTimerDisplay();
                    if (timeLeft <= 0) forceNext();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const m = Math.floor(timeLeft / 60).toString().padStart(2,'0');
            const s = (timeLeft % 60).toString().padStart(2,'0');
            const el = document.getElementById('hud-timer');
            el.innerText = `${m}:${s}`;
            el.style.color = timeLeft <= 5 ? '#ff4757' : '#00d2d3';
        }

        function forceNext() {
            currentIdx++;
            loadSlide();
        }

        function prevImage() {
            if (currentIdx > 0) {
                currentIdx--;
                loadSlide();
            }
        }

        function togglePause() {
            isPaused = !isPaused;
            updatePauseIcon();
        }

        function updatePauseIcon() {
            const btn = document.getElementById('btn-pause');
            const playPath = "M8 5v14l11-7z";
            const pausePath = "M6 19h4V5H6v14zm8-14v14h4V5h-4z";
            btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="${isPaused ? playPath : pausePath}"/></svg>`;
        }

        function endSession() {
            clearInterval(timerInterval);
            document.getElementById('hud-controls').classList.remove('hidden');
            alert("–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!");
            // –í–æ–∑–≤—Ä–∞—Ç
            if (isFlatMode) location.reload();
            else switchScreen('screen-settings');
        }

        function hideUI(e) {
            e.stopPropagation();
            document.getElementById('hud-controls').classList.add('hidden');
        }

        function showUI() {
            const controls = document.getElementById('hud-controls');
            if (controls.classList.contains('hidden')) {
                controls.classList.remove('hidden');
            }
        }

        // Hotkeys
        document.addEventListener('keydown', (e) => {
            if (!document.getElementById('screen-player').classList.contains('active')) return;
            if (e.code === 'Space') { e.preventDefault(); togglePause(); }
            if (e.code === 'ArrowRight') forceNext();
            if (e.code === 'ArrowLeft') prevImage();
            if (e.code === 'Escape') endSession();
            if (e.code === 'KeyH') document.getElementById('hud-controls').classList.toggle('hidden');
        });

    </script>
</body>
</html>